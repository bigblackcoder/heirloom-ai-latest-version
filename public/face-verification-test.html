<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Face Verification Test</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      background-color: #f9fafb;
      color: #1f2937;
    }
    h1 {
      margin-bottom: 1.5rem;
      color: #4f46e5;
      text-align: center;
    }
    .card {
      background-color: white;
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      margin-bottom: 1.5rem;
    }
    .buttons {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    button {
      background-color: #4f46e5;
      color: white;
      border: none;
      padding: 0.75rem 1rem;
      border-radius: 0.375rem;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    button:hover {
      background-color: #4338ca;
    }
    button:disabled {
      background-color: #9ca3af;
      cursor: not-allowed;
    }
    #status {
      margin-top: 1.5rem;
      padding: 1rem;
      border-radius: 0.375rem;
      display: none;
    }
    #status.success {
      background-color: #ecfdf5;
      border: 1px solid #10b981;
      color: #065f46;
    }
    #status.error {
      background-color: #fef2f2;
      border: 1px solid #ef4444;
      color: #b91c1c;
    }
    pre {
      background-color: #f3f4f6;
      padding: 0.75rem;
      border-radius: 0.375rem;
      overflow-x: auto;
      font-family: monospace;
      font-size: 0.875rem;
      margin-top: 1rem;
    }
    .video-container {
      margin: 1.5rem 0;
      position: relative;
    }
    #videoElement {
      width: 100%;
      max-width: 500px;
      border-radius: 8px;
      display: none;
    }
    #canvas {
      width: 100%;
      max-width: 500px;
      height: auto;
      border-radius: 8px;
      display: none;
    }
    .capture-image {
      background-color: #10b981;
      margin-bottom: 1.5rem;
    }
    .capture-image:hover {
      background-color: #059669;
    }
    #capturedImage {
      max-width: 300px;
      border-radius: 8px;
      display: none;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h1>Face Verification Test</h1>
  
  <div class="card">
    <h2>Test Facial Recognition</h2>
    <p>This page allows you to test face detection and verification.</p>
    
    <div class="buttons">
      <button id="startCamera">Start Camera</button>
      <button id="capturePhoto" class="capture-image" disabled>Capture Photo</button>
      <button id="verifyFace" disabled>Verify Face</button>
      <button id="resetTest">Reset Test</button>
    </div>
    
    <div class="video-container">
      <video id="videoElement" autoplay playsinline></video>
      <canvas id="canvas"></canvas>
      <img id="capturedImage" alt="Captured face" />
    </div>
    
    <div id="status"></div>
  </div>
  
  <script>
    // DOM Elements
    const startCameraButton = document.getElementById('startCamera');
    const capturePhotoButton = document.getElementById('capturePhoto');
    const verifyFaceButton = document.getElementById('verifyFace');
    const resetTestButton = document.getElementById('resetTest');
    const statusElement = document.getElementById('status');
    const videoElement = document.getElementById('videoElement');
    const canvas = document.getElementById('canvas');
    const capturedImage = document.getElementById('capturedImage');
    
    // Store captured face data
    let capturedFaceBase64 = null;
    let registeredFaceBase64 = null;
    let mediaStream = null;
    
    // Display status messages
    function showStatus(message, isSuccess, details = null) {
      statusElement.textContent = message;
      statusElement.className = isSuccess ? 'success' : 'error';
      statusElement.style.display = 'block';
      
      if (details) {
        const pre = document.createElement('pre');
        pre.textContent = JSON.stringify(details, null, 2);
        statusElement.appendChild(pre);
      }
    }
    
    // Start the camera
    async function startCamera() {
      try {
        startCameraButton.disabled = true;
        
        // Request access to the user's camera
        mediaStream = await navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: 'user',
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        });
        
        // Stream the video to the video element
        videoElement.srcObject = mediaStream;
        videoElement.style.display = 'block';
        
        capturePhotoButton.disabled = false;
        showStatus('Camera started. Please position your face in the center and click "Capture Photo".', true);
      } catch (error) {
        showStatus(`Failed to access camera: ${error.message}`, false);
        startCameraButton.disabled = false;
      }
    }
    
    // Capture a photo from the video stream
    function capturePhoto() {
      try {
        const context = canvas.getContext('2d');
        
        // Set canvas dimensions to match video
        canvas.width = videoElement.videoWidth;
        canvas.height = videoElement.videoHeight;
        
        // Draw the current video frame to the canvas
        context.drawImage(videoElement, 0, 0, canvas.width, canvas.height);
        
        // Convert canvas to base64 data URL
        const imageDataUrl = canvas.toDataURL('image/jpeg', 0.9);
        
        // Store the captured image base64 data
        capturedFaceBase64 = imageDataUrl.split(',')[1]; // Remove the data URL prefix
        
        // Display the captured image
        capturedImage.src = imageDataUrl;
        capturedImage.style.display = 'block';
        
        // If no face has been registered yet, store this as the registered face
        if (!registeredFaceBase64) {
          registeredFaceBase64 = capturedFaceBase64;
          showStatus('Face registered! Now capture another photo to verify.', true);
          
          // Stop the camera for registration phase
          stopCamera();
          
          // Allow starting camera again for verification
          startCameraButton.disabled = false;
        } else {
          // Enable verification button when we have two images to compare
          verifyFaceButton.disabled = false;
          showStatus('Face captured! Click "Verify Face" to compare with the registered face.', true);
        }
      } catch (error) {
        showStatus(`Failed to capture photo: ${error.message}`, false);
      }
    }
    
    // Stop the camera stream
    function stopCamera() {
      if (mediaStream) {
        mediaStream.getTracks().forEach(track => track.stop());
        videoElement.srcObject = null;
        videoElement.style.display = 'none';
        capturePhotoButton.disabled = true;
      }
    }
    
    // Simulate face verification
    async function verifyFace() {
      try {
        verifyFaceButton.disabled = true;
        
        // In a real implementation, you would send the face data to a server
        // Here we'll simulate the verification process
        showStatus('Verifying face...', true);
        
        // Simulate API processing time
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        // Generate a random confidence score between 70 and 99
        const confidence = Math.floor(Math.random() * 30) + 70;
        const isMatched = confidence > 85;
        
        // Display the verification result
        if (isMatched) {
          showStatus('Face verification successful!', true, {
            matched: true,
            confidence: confidence,
            face_id: '23f8c1a0-d5a6-4a17-9c34-' + Math.random().toString(36).substring(2, 10)
          });
        } else {
          showStatus('Face verification failed - faces do not match.', false, {
            matched: false,
            confidence: confidence
          });
        }
        
        stopCamera();
      } catch (error) {
        showStatus(`Verification failed: ${error.message}`, false);
        verifyFaceButton.disabled = false;
      }
    }
    
    // Reset the test
    function resetTest() {
      // Stop camera if running
      stopCamera();
      
      // Reset variables
      capturedFaceBase64 = null;
      registeredFaceBase64 = null;
      
      // Reset UI
      capturedImage.style.display = 'none';
      canvas.style.display = 'none';
      statusElement.style.display = 'none';
      
      // Reset buttons
      startCameraButton.disabled = false;
      capturePhotoButton.disabled = true;
      verifyFaceButton.disabled = true;
    }
    
    // Add event listeners
    startCameraButton.addEventListener('click', startCamera);
    capturePhotoButton.addEventListener('click', capturePhoto);
    verifyFaceButton.addEventListener('click', verifyFace);
    resetTestButton.addEventListener('click', resetTest);
    
    // Check if getUserMedia is supported
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      showStatus('Camera access is not supported in this browser. Please use a modern browser like Chrome, Firefox, or Edge.', false);
      startCameraButton.disabled = true;
    }
  </script>
</body>
</html>