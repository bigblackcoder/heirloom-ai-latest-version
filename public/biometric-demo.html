<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Heirloom Identity - Biometric Authentication Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .card {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.375rem;
            font-weight: 500;
            padding: 0.5rem 1rem;
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .button-primary {
            background-color: #4f46e5;
            color: white;
        }
        
        .button-primary:hover {
            background-color: #4338ca;
        }
        
        .button-outline {
            background-color: transparent;
            border: 1px solid #d1d5db;
            color: #374151;
        }
        
        .button-outline:hover {
            background-color: #f9fafb;
        }
        
        .alert {
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .alert-success {
            background-color: #ecfdf5;
            border: 1px solid #d1fae5;
            color: #065f46;
        }
        
        .alert-error {
            background-color: #fef2f2;
            border: 1px solid #fee2e2;
            color: #b91c1c;
        }
        
        .badge {
            display: inline-flex;
            align-items: center;
            border-radius: 9999px;
            padding: 0.25rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 500;
            margin-right: 0.5rem;
            cursor: pointer;
        }
        
        .badge-default {
            background-color: #4f46e5;
            color: white;
        }
        
        .badge-outline {
            background-color: transparent;
            border: 1px solid #d1d5db;
            color: #374151;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Heirloom Identity Platform</h1>
            <p class="text-gray-600">Device-Native Biometric Authentication Demo</p>
        </header>
        
        <main>
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Registration Card -->
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c0 3.517-1.009 6.799-2.753 9.571m-3.44-2.04l.054-.09A13.916 13.916 0 008 11a4 4 0 118 0c0 1.017-.07 2.019-.203 3m-2.118 6.844A21.88 21.88 0 0015.171 17m3.839 1.132c.645-2.266.99-4.659.99-7.132A8 8 0 008 4.07M3 15.364c.64-1.319 1-2.8 1-4.364 0-1.457.39-2.823 1.07-4" />
                        </svg>
                        Register Device Biometric
                    </h2>
                    
                    <p class="text-gray-600 mb-4">Register your device biometric for secure authentication. Your biometric data stays on your device.</p>
                    
                    <div id="register-status" class="mb-4 hidden"></div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">User ID</label>
                        <input type="number" id="register-user-id" class="w-full border-gray-300 rounded-md shadow-sm p-2 border" value="1">
                    </div>
                    
                    <div class="mb-4">
                        <div class="flex flex-wrap gap-2 mb-2">
                            <span class="text-sm font-medium text-gray-700 mr-2">Biometric type:</span>
                            <span class="badge badge-default" data-type="face" onclick="selectBiometricType(this)">Face</span>
                            <span class="badge badge-outline" data-type="fingerprint" onclick="selectBiometricType(this)">Fingerprint</span>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-blue-50 rounded-md border border-blue-100">
                        <h4 class="text-sm font-semibold flex items-center gap-2 mb-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                            </svg>
                            Privacy Protection
                        </h4>
                        <p class="text-sm text-gray-700">
                            Your biometric data never leaves your device. We only store verification
                            metadata for authentication purposes.
                        </p>
                    </div>
                    
                    <div class="mt-4">
                        <button id="register-button" class="button button-primary" onclick="handleRegister()">
                            Register Face ID
                        </button>
                    </div>
                </div>
                
                <!-- Verification Card -->
                <div class="card">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                        </svg>
                        Verify Your Identity
                    </h2>
                    
                    <p class="text-gray-600 mb-4">Verify your identity using your device biometric. Secure and private.</p>
                    
                    <div id="verify-status" class="mb-4 hidden"></div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">User ID (optional)</label>
                        <input type="number" id="verify-user-id" class="w-full border-gray-300 rounded-md shadow-sm p-2 border" placeholder="Leave empty to check all users">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Credential ID</label>
                        <input type="text" id="credential-id" class="w-full border-gray-300 rounded-md shadow-sm p-2 border" placeholder="From registration">
                    </div>
                    
                    <div class="mt-4">
                        <button id="verify-button" class="button button-primary" onclick="handleVerify()">
                            Verify Identity
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Device Info Card -->
            <div class="card mt-6">
                <h2 class="text-xl font-semibold mb-4">Device Capabilities</h2>
                <div id="device-info">Detecting device capabilities...</div>
                <button class="button button-outline mt-4" onclick="detectDeviceCapabilities()">
                    Re-detect Capabilities
                </button>
            </div>
            
            <!-- Results Log -->
            <div class="card mt-6">
                <h2 class="text-xl font-semibold mb-4">Results Log</h2>
                <pre id="results-log" class="bg-gray-100 p-4 rounded text-sm overflow-auto max-h-96">Results will appear here...</pre>
            </div>
        </main>
    </div>
    
    <script>
        // State
        let selectedBiometricType = 'face';
        let deviceCapabilities = null;
        let registeredCredentialId = null;
        
        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            detectDeviceCapabilities();
        });
        
        // Helper functions
        function selectBiometricType(element) {
            // Update UI
            document.querySelectorAll('.badge').forEach(badge => {
                badge.classList.remove('badge-default');
                badge.classList.add('badge-outline');
            });
            
            element.classList.remove('badge-outline');
            element.classList.add('badge-default');
            
            // Update state
            selectedBiometricType = element.dataset.type;
            
            // Update button text
            document.getElementById('register-button').textContent = 
                `Register ${capitalizeFirstLetter(selectedBiometricType)}`;
        }
        
        function capitalizeFirstLetter(string) {
            return string.charAt(0).toUpperCase() + string.slice(1);
        }
        
        function showAlert(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.className = `alert alert-${type}`;
            element.textContent = message;
            element.classList.remove('hidden');
        }
        
        function hideAlert(elementId) {
            const element = document.getElementById(elementId);
            element.classList.add('hidden');
        }
        
        function addToLog(message) {
            const log = document.getElementById('results-log');
            const timestamp = new Date().toLocaleTimeString();
            log.textContent = `[${timestamp}] ${message}\n${log.textContent}`;
        }
        
        // API functions
        async function detectDeviceCapabilities() {
            const deviceInfoElement = document.getElementById('device-info');
            deviceInfoElement.innerHTML = "Detecting device capabilities...";
            
            try {
                // In a real app, this would call our API to detect device capabilities
                // Here we're simulating the response
                
                // First, let's get a challenge from the server
                const challengeResponse = await fetch('/api/biometrics/challenge');
                const challengeData = await challengeResponse.json();
                
                // Check if WebAuthn is supported
                const supportsWebAuthn = window.PublicKeyCredential !== undefined && 
                    typeof window.PublicKeyCredential === 'function';
                
                // Detect device type
                const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                const isTablet = /iPad|Android/i.test(navigator.userAgent) && !/Mobile/i.test(navigator.userAgent);
                
                // Detect platform
                const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
                const isAndroid = /Android/i.test(navigator.userAgent);
                
                let platform = 'web';
                if (isIOS) platform = 'ios';
                else if (isAndroid) platform = 'android';
                
                // Determine supported biometrics based on device
                let supportedBiometrics = [];
                if (supportsWebAuthn) {
                    supportedBiometrics = ['fingerprint', 'face'];
                } else if (platform === 'ios') {
                    supportedBiometrics = ['face', 'fingerprint']; // Face ID, Touch ID
                } else if (platform === 'android') {
                    supportedBiometrics = ['fingerprint', 'face']; // Fingerprint, Face Unlock
                }
                
                const deviceType = isTablet ? 'tablet' : (isMobile ? 'mobile' : 'desktop');
                
                deviceCapabilities = {
                    type: deviceType,
                    platform,
                    supportsBiometrics: supportsWebAuthn || platform !== 'web',
                    supportedBiometrics
                };
                
                // Update UI
                deviceInfoElement.innerHTML = `
                    <div class="space-y-2">
                        <p><strong>Device type:</strong> ${deviceType}</p>
                        <p><strong>Platform:</strong> ${platform}</p>
                        <p><strong>Biometric support:</strong> ${deviceCapabilities.supportsBiometrics ? 'Yes' : 'No'}</p>
                        <p><strong>Supported biometrics:</strong> ${deviceCapabilities.supportedBiometrics.length > 0 
                            ? deviceCapabilities.supportedBiometrics.map(b => capitalizeFirstLetter(b)).join(', ') 
                            : 'None'}</p>
                        <p><strong>Challenge received:</strong> ${challengeData.value.substring(0, 10)}...</p>
                    </div>
                `;
                
                addToLog(`Device detected: ${deviceType} (${platform}) with biometric support: ${deviceCapabilities.supportsBiometrics}`);
            } catch (error) {
                deviceInfoElement.innerHTML = `
                    <div class="alert alert-error">
                        Error detecting device capabilities: ${error.message}
                    </div>
                `;
                addToLog(`ERROR: ${error.message}`);
            }
        }
        
        async function handleRegister() {
            hideAlert('register-status');
            const registerButton = document.getElementById('register-button');
            const userId = document.getElementById('register-user-id').value;
            
            if (!userId) {
                showAlert('register-status', 'User ID is required', 'error');
                return;
            }
            
            if (!deviceCapabilities?.supportsBiometrics) {
                showAlert('register-status', 'This device does not support biometric authentication', 'error');
                return;
            }
            
            // Update UI
            registerButton.textContent = 'Registering...';
            registerButton.disabled = true;
            
            try {
                addToLog(`Starting biometric registration for user ${userId}`);
                
                // Get a challenge from the server
                const challengeResponse = await fetch('/api/biometrics/challenge');
                const challengeData = await challengeResponse.json();
                
                // Simulate triggering native biometric registration
                addToLog('Simulating device biometric prompt...');
                
                // In a real app, this would trigger WebAuthn registration
                // Here we're simulating the process
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // Generate a simulated credential ID
                const simulatedCredentialId = `bio_${Date.now()}_${Math.random().toString(36).substring(2, 15)}`;
                
                // Register with the server
                const response = await fetch('/api/biometrics/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: parseInt(userId),
                        credentialId: simulatedCredentialId,
                        biometricType: selectedBiometricType,
                        deviceType: deviceCapabilities.platform,
                        challenge: challengeData.value
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('register-status', `Successfully registered ${selectedBiometricType}`, 'success');
                    registeredCredentialId = simulatedCredentialId;
                    document.getElementById('credential-id').value = simulatedCredentialId;
                    addToLog(`Registration successful! Credential ID: ${simulatedCredentialId}`);
                } else {
                    showAlert('register-status', data.message || 'Registration failed', 'error');
                    addToLog(`Registration failed: ${data.message}`);
                }
            } catch (error) {
                showAlert('register-status', `Registration error: ${error.message}`, 'error');
                addToLog(`ERROR: ${error.message}`);
            } finally {
                // Restore UI
                registerButton.textContent = `Register ${capitalizeFirstLetter(selectedBiometricType)}`;
                registerButton.disabled = false;
            }
        }
        
        async function handleVerify() {
            hideAlert('verify-status');
            const verifyButton = document.getElementById('verify-button');
            const userId = document.getElementById('verify-user-id').value;
            const credentialId = document.getElementById('credential-id').value;
            
            if (!credentialId) {
                showAlert('verify-status', 'Credential ID is required', 'error');
                return;
            }
            
            if (!deviceCapabilities?.supportsBiometrics) {
                showAlert('verify-status', 'This device does not support biometric authentication', 'error');
                return;
            }
            
            // Update UI
            verifyButton.textContent = 'Verifying...';
            verifyButton.disabled = true;
            
            try {
                addToLog(`Starting biometric verification with credential: ${credentialId}`);
                
                // Get a challenge from the server
                const challengeResponse = await fetch('/api/biometrics/challenge');
                const challengeData = await challengeResponse.json();
                
                // Simulate triggering native biometric verification
                addToLog('Simulating device biometric prompt...');
                
                // In a real app, this would trigger WebAuthn verification
                // Here we're simulating the process
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                // Verify with the server
                const response = await fetch('/api/biometrics/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        credentialId,
                        userId: userId ? parseInt(userId) : undefined,
                        challenge: challengeData.value
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showAlert('verify-status', 'Identity verified successfully', 'success');
                    addToLog(`Verification successful! User ID: ${data.userId}, Time: ${data.timestamp}`);
                } else {
                    showAlert('verify-status', data.message || 'Verification failed', 'error');
                    addToLog(`Verification failed: ${data.message || 'Unknown error'}`);
                }
            } catch (error) {
                showAlert('verify-status', `Verification error: ${error.message}`, 'error');
                addToLog(`ERROR: ${error.message}`);
            } finally {
                // Restore UI
                verifyButton.textContent = 'Verify Identity';
                verifyButton.disabled = false;
            }
        }
    </script>
</body>
</html>